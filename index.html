<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>RUANGSEJARAH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Oswald:wght@600&display=swap');
        
        :root { 
            --bg: #0f172a; --card: #f8fafc; --accent: #e11d48; 
            --ink: #1e293b; --soldier-off: #cbd5e1; --soldier-on: #22c55e; 
        }

        body { 
            margin: 0; background: var(--bg); color: var(--ink); 
            font-family: 'Courier Prime', monospace; overflow-x: hidden;
        }

        header { 
            background: #1e293b; color: white; padding: 25px; 
            text-align: center; border-bottom: 6px solid var(--accent);
        }
        header h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 2.5rem; letter-spacing: 3px; }

        main { max-width: 800px; margin: 40px auto; padding: 0 20px; }

        .card { 
            background: #fffefb; border-radius: 4px; padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 2px solid var(--ink);
            border-right: 12px solid var(--accent); position: relative;
        }

        .form-group { margin-bottom: 25px; }
        input[type="text"] {
            width: 100%; padding: 18px; font-size: 1.2rem; border: 3px solid var(--ink);
            border-radius: 0; font-family: inherit; box-sizing: border-box; background: #fff;
        }

        button {
            width: 100%; padding: 18px; background: var(--ink); color: white;
            border: none; font-size: 1rem; font-weight: bold; cursor: pointer;
            text-transform: uppercase; transition: 0.2s;
        }
        button:hover { background: var(--accent); }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: #f1f5f9; padding: 15px; border: 2px solid var(--ink); text-align: center; }
        .stat-box b { font-size: 1.5rem; display: block; color: var(--accent); }

        .army-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; margin: 30px 0; }
        .dot { 
            width: 100%; aspect-ratio: 1; background: var(--soldier-off); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 11px;
            font-weight: bold; border: 1px solid #94a3b8; color: #64748b;
        }
        .dot.active { background: var(--soldier-on); color: white; border-color: #166534; box-shadow: 0 0 10px rgba(34, 197, 94, 0.4); }
        .dot.me { border: 3px solid var(--accent); animation: glow 1.5s infinite; }

        @keyframes glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .hidden { display: none !important; }

        /* Admin Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8rem; }
        th { background: var(--ink); color: white; padding: 10px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        
        /* Modal Laporan */
        .report-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .report-card { background: white; width: 100%; max-width: 600px; max-height: 85vh; overflow-y: auto; padding: 30px; border-radius: 4px; border-top: 10px solid var(--ink); }
        .log-item { border-bottom: 1px dashed #ccc; padding: 12px 0; }
        .log-item b { color: var(--accent); font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <h1>RUANGSEJARAH</h1>
    <div style="letter-spacing: 4px; font-size: 0.7rem;">SISTEM EVALUASI STRATEGIS v27</div>
</header>

<main>
    <div id="scr-login" class="card">
        <h2 style="text-align:center; margin-top:0;">REGISTRASI UNIT</h2>
        <div class="form-group">
            <input type="text" id="in-name" placeholder="NAMA LENGKAP..." autocomplete="off">
        </div>
        <button id="btn-reg">AKTIFKAN UNIT ⮕KOMANDAN UTAMA</button>
        <p style="text-align:center;"><a href="#" id="link-admin" style="color:var(--accent); font-size:0.8rem; text-decoration:none;"></a></p>
    </div>

    <div id="scr-wait" class="card hidden">
        <h2 style="text-align:center;">BARAK PERSIAPAN</h2>
        <div class="army-container" id="army-grid"></div>
        <p style="text-align:center; color:#64748b;" id="lbl-wait">Menunggu perintah serangan...</p>
        <div style="background:#f1f5f9; padding:15px; text-align:center; font-weight:bold; border:1px solid #ddd;">
            KODE UNIT: <span id="display-name" style="color:var(--accent)">--</span>
        </div>
    </div>

    <div id="scr-game" class="card hidden">
        <div class="stat-grid">
            <div class="stat-box"><small>MORAL</small><b id="v-m">50</b></div>
            <div class="stat-box"><small>SUPLAI</small><b id="b-l">50</b></div>
            <div class="stat-box"><small>DUKUNGAN</small><b id="v-s">50</b></div>
        </div>
        <h3 id="ev-title" style="color:var(--accent); margin-top:0;"></h3>
        <p id="ev-desc" style="line-height:1.6; min-height:80px;"></p>
        <div id="opt-container"></div>
        
        <div id="ref-box" class="hidden">
            <p><b>JUSTIFIKASI KEPUTUSAN:</b></p>
            <textarea id="ref-input" style="width:100%; height:80px; padding:10px; font-family:inherit; border:2px solid var(--ink);" placeholder="Mengapa Anda mengambil langkah ini?"></textarea>
            <button id="btn-submit-turn" style="margin-top:15px;">KIRIM LAPORAN</button>
        </div>
    </div>

    <div id="scr-admin" class="card hidden">
        <h2 style="margin-top:0;">KONTROL OTORITAS</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <button id="btn-start-global" style="background:#16a34a;">MULAI GAME</button>
            <button id="btn-reset-global" style="background:#dc2626;">RESET TOTAL</button>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>UNIT</th><th>PROGRESS</th><th>M/L/S</th><th>AKSI</th></tr>
                </thead>
                <tbody id="monitor-body"></tbody>
            </table>
        </div>
    </div>
</main>

<div id="scr-report" class="report-overlay hidden">
    <div class="report-card">
        <h2 id="rep-unit-name" style="margin-top:0; border-bottom: 3px solid var(--ink);">LAPORAN DETAIL</h2>
        <div id="rep-list"></div>
        <button onclick="document.getElementById('scr-report').classList.add('hidden')" style="margin-top:20px;">TUTUP</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAclyNf8Dy69UD0X9IwuNo4QH3BfAzmfZY",
        authDomain: "sejarah-game.firebaseapp.com",
        projectId: "sejarah-game",
        databaseURL: "https://sejarah-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let pData = { id:"", name:"", m:50, l:50, s:50, cur:0, history:[] };
    let missions = [];
    let allPlayersData = {};

    const showScreen = (id) => {
        document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    // --- MURID ---
    document.getElementById('btn-reg').onclick = () => {
        const n = document.getElementById('in-name').value.trim().toUpperCase();
        if(!n) return alert("NAMA TIDAK BOLEH KOSONG!");
        pData.id = n.replace(/\s+/g, '_') + '_' + Math.floor(1000 + Math.random() * 9000);
        pData.name = n;
        set(ref(db, 'players/' + pData.id), { name: n, m:50, l:50, s:50, cur:0, status:'ALIVE', history:[] });
        document.getElementById('display-name').innerText = n;
        showScreen('scr-wait');
    };

    const renderTurn = () => {
        if(pData.cur >= missions.length) {
            document.getElementById('scr-game').innerHTML = "<h2 style='text-align:center'>MISI SELESAI</h2><p style='text-align:center'>Laporan akhir Anda telah diarsipkan oleh Guru.</p>";
            return;
        }
        const ev = missions[pData.cur];
        document.getElementById('ev-title').innerText = `${ev.t}: ${ev.title}`;
        document.getElementById('ev-desc').innerText = ev.desc;
        const cont = document.getElementById('opt-container');
        cont.innerHTML = "";

        ev.options.forEach(o => {
            const b = document.createElement('button');
            b.style = "background:white; color:var(--ink); border:2px solid var(--ink); margin-bottom:10px; text-align:left;";
            b.innerText = "◈ " + o.text;
            b.onclick = () => {
                pData.m += o.m; pData.l += o.l; pData.s += o.s;
                document.getElementById('v-m').innerText = pData.m;
                document.getElementById('b-l').innerText = pData.l;
                document.getElementById('v-s').innerText = pData.s;
                cont.innerHTML = ""; document.getElementById('ref-box').classList.remove('hidden');
            };
            cont.appendChild(b);
        });
    };

    document.getElementById('btn-submit-turn').onclick = () => {
        const reason = document.getElementById('ref-input').value;
        const log = { year: missions[pData.cur].t, title: missions[pData.cur].title, reason: reason };
        if(!pData.history) pData.history = [];
        pData.history.push(log);
        pData.cur++;
        
        update(ref(db, 'players/' + pData.id), { 
            m: pData.m, l: pData.l, s: pData.s, cur: pData.cur, history: pData.history 
        });
        
        document.getElementById('ref-input').value = "";
        document.getElementById('ref-box').classList.add('hidden');
        renderTurn();
    };

    // --- ADMIN ---
    document.getElementById('link-admin').onclick = (e) => {
        e.preventDefault();
        if(prompt("SANDI OTORITAS:") === "sejarah") showScreen('scr-admin');
    };

    document.getElementById('btn-start-global').onclick = () => {
        const m = [];
        for(let i=1; i<=25; i++) {
            m.push({
                t: 1945 + i, title: `KRISIS TAHUN ${1945+i}`,
                desc: `Sebuah konflik meletus di sektor selatan. Rakyat meminta perlindungan, namun stok amunisi menipis.`,
                options: [
                    {text: "Utamakan Diplomasi Rakyat", m:10, l:-10, s:15},
                    {text: "Serangan Militer Terpadu", m:-5, l:15, s:0}
                ]
            });
        }
        set(ref(db, 'missions'), m);
        set(ref(db, 'gameStatus'), 'PLAYING');
    };

    document.getElementById('btn-reset-global').onclick = () => {
        if(confirm("HAPUS SELURUH DATA?")) {
            set(ref(db, 'players'), null);
            set(ref(db, 'gameStatus'), 'WAITING');
        }
    };

    window.kickPlayer = (id) => { if(confirm("Hapus unit ini?")) remove(ref(db, 'players/' + id)); };
    
    window.viewReport = (id) => {
        const p = allPlayersData[id];
        document.getElementById('rep-unit-name').innerText = "LAPORAN: " + p.name;
        const list = document.getElementById('rep-list');
        list.innerHTML = p.history ? p.history.map((h, i) => `
            <div class="log-item">
                <b>[MISI ${i+1}] ${h.year} - ${h.title}</b><br>
                <span>"${h.reason || 'Tidak ada justifikasi'}"</span>
            </div>
        `).join('') : "Belum ada laporan.";
        document.getElementById('scr-report').classList.remove('hidden');
    };

    // --- SYNC ---
    onValue(ref(db, 'missions'), s => missions = s.val() || []);
    onValue(ref(db, 'gameStatus'), s => {
        if(s.val() === 'PLAYING' && !document.getElementById('scr-wait').classList.contains('hidden')) {
            showScreen('scr-game'); renderTurn();
        }
    });

    onValue(ref(db, 'players'), snap => {
        const players = snap.val() || {};
        allPlayersData = players;

        // Kick logic
        if(pData.id && !players[pData.id]) { pData.id = ""; showScreen('scr-login'); return; }

        // Grid Update
        const grid = document.getElementById('army-grid');
        grid.innerHTML = "";
        const ids = Object.keys(players);
        for(let i=0; i<40; i++) {
            const d = document.createElement('div'); d.className = 'dot';
            if(ids[i]) {
                d.classList.add('active'); if(ids[i] === pData.id) d.classList.add('me');
                d.innerText = players[ids[i]].name.substring(0,2);
            } else { d.innerText = i+1; }
            grid.appendChild(d);
        }

        // Admin Table
        const tbody = document.getElementById('monitor-body');
        if(tbody) tbody.innerHTML = ids.map(id => `
            <tr>
                <td>${players[id].name}</td>
                <td>${players[id].cur}/25</td>
                <td>${players[id].m}/${players[id].l}/${players[id].s}</td>
                <td>
                    <button onclick="window.viewReport('${id}')" style="background:#0ea5e9; padding:5px; font-size:9px; width:auto; margin-bottom:2px;">DETAIL</button>
                    <button onclick="window.kickPlayer('${id}')" style="background:red; padding:5px; font-size:9px; width:auto;">KICK</button>
                </td>
            </tr>`).join('');
    });
</script>
</body>
</html>
