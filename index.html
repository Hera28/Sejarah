<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>RUANGSEJARAH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=Crimson+Text:wght@400;700&display=swap');
        :root { --ink: #003049; --paper: #fdf0d5; --gold: #c1121f; --danger: #d62828; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Crimson Text', serif; background: #121212; color: var(--ink); }
        header { background: var(--ink); color: white; padding: 1rem; text-align: center; font-family: 'Special Elite'; border-bottom: 4px solid var(--gold); }
        main { max-width: 900px; margin: 0 auto; padding: 1rem; }
        .card { background: var(--paper); padding: 1.5rem; border: 3px solid var(--ink); box-shadow: 8px 8px 0 var(--gold); border-radius: 4px; margin-bottom: 2rem; }
        .hidden { display: none !important; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1rem; }
        .stat-box { background: rgba(255,255,255,0.7); padding: 0.8rem; text-align: center; border: 2px solid var(--ink); border-radius: 4px; }
        .stat-box b { font-size: 1.4rem; color: var(--gold); font-family: 'Special Elite'; }
        button { padding: 12px; background: var(--ink); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; width: 100%; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid var(--ink); border-radius: 4px; font-family: inherit; }
        .opt-btn { background: white; color: var(--ink); text-align: left; border: 2px solid var(--ink); margin-bottom: 8px; font-weight: normal; }
        .admin-scroll { overflow-x: auto; max-height: 500px; margin-top: 1rem; border: 1px solid #ccc; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.85rem; min-width: 700px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background: var(--ink); color: white; position: sticky; top: 0; }
        .btn-kick { background: var(--danger) !important; width: auto !important; padding: 5px 10px !important; }
        .btn-edit { background: #f39c12 !important; width: auto !important; padding: 5px 10px !important; margin-right: 5px; }
    </style>
</head>
<body>

<header><h1>RUANGSEJARAH</h1></header>

<main>
    <div id="scr-login" class="card">
        <h2 style="text-align:center;">Registrasi Komandan</h2>
        <input type="text" id="in-name" placeholder="Nama Lengkap..." autocomplete="off">
        <button id="btn-reg">MASUK SIMULASI â®•</button>
        <p style="text-align:center;"><a href="#" id="link-admin" style="color:var(--gold); font-size:0.8rem;">Mode Guru</a></p>
    </div>

    <div id="scr-wait" class="card hidden">
        <h2 style="text-align:center;">MENUNGGU KOMANDO</h2>
        <div style="text-align:center; font-size: 3rem; animation: pulse 1s infinite;">ðŸ“¡</div>
        <p style="text-align:center;">Unit <b id="lbl-myname"></b> tersambung.</p>
        <p id="wait-msg" style="text-align:center; color: var(--gold);">Mengunduh data misi...</p>
    </div>

    <div id="scr-kicked" class="card hidden">
        <h2 style="color:var(--danger); text-align:center;">AKSES DICABUT</h2>
        <p style="text-align:center;">Anda telah dikeluarkan oleh Guru.</p>
        <button onclick="location.reload()">KEMBALI</button>
    </div>

    <div id="scr-game" class="card hidden">
        <div class="stat-grid">
            <div class="stat-box">MORAL<br><b id="v-m">50</b></div>
            <div class="stat-box">SUPLAI<br><b id="v-l">50</b></div>
            <div class="stat-box">DUKUNGAN<br><b id="v-s">50</b></div>
        </div>
        <h3 id="ev-title" style="color:var(--gold); font-family:'Special Elite';"></h3>
        <p id="ev-desc"></p>
        <div id="opt-container"></div>
        <div id="ref-box" class="hidden">
            <hr><p><b>Alasan Strategis:</b></p>
            <textarea id="ref-input" rows="3"></textarea>
            <button id="btn-submit-turn">KIRIM DATA â®•</button>
        </div>
    </div>

    <div id="scr-admin" class="card hidden">
        <h2>Panel Guru</h2>
        <div style="display:flex; gap:10px;">
            <button id="btn-start-global" style="background:#2d6a4f;">MULAI GAME</button>
            <button id="btn-reset-global" style="background:var(--gold);">RESET SEMUA</button>
        </div>
        <div class="admin-scroll">
            <table>
                <thead><tr><th>Nama</th><th>Misi</th><th>Statistik</th><th>Moderasi</th></tr></thead>
                <tbody id="monitor-body"></tbody>
            </table>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAclyNf8Dy69UD0X9IwuNo4QH3BfAzmfZY",
        authDomain: "sejarah-game.firebaseapp.com",
        projectId: "sejarah-game",
        databaseURL: "https://sejarah-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let pData = { id:"", name:"", m:50, l:50, s:50, cur:0 };
    let missions = [];

    const showScreen = (id) => {
        document.querySelectorAll('.card').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    // --- LOGIKA MURID ---
    document.getElementById('btn-reg').onclick = () => {
        const n = document.getElementById('in-name').value.trim();
        if(!n) return alert("Nama wajib diisi!");
        pData.id = n.replace(/\s+/g, '_');
        pData.name = n;
        set(ref(db, 'players/' + pData.id), { name: pData.name, m:50, l:50, s:50, cur:0, status: 'ALIVE' });
        document.getElementById('lbl-myname').innerText = pData.name;
        showScreen('scr-wait');
    };

    const renderTurn = () => {
        // PERBAIKAN: Cek apakah misi sudah terunduh
        if (missions.length === 0) {
            alert("Misi belum dimuat dari server. Tunggu sebentar.");
            return;
        }

        if(pData.cur >= missions.length) {
            document.getElementById('scr-game').innerHTML = "<h2 style='text-align:center;'>MISI SELESAI</h2>";
            return;
        }
        
        const ev = missions[pData.cur];
        document.getElementById('ev-title').innerText = `${ev.t || ''}: ${ev.title}`;
        document.getElementById('ev-desc').innerText = ev.desc;
        const cont = document.getElementById('opt-container');
        cont.innerHTML = "";
        
        ev.options.forEach(o => {
            const b = document.createElement('button');
            b.className = 'opt-btn'; b.innerText = o.text;
            b.onclick = () => {
                pData.m += parseInt(o.m || 0); pData.l += parseInt(o.l || 0); pData.s += parseInt(o.s || 0);
                ['v-m','v-l','v-s'].forEach((id,i) => document.getElementById(id).innerText = [pData.m,pData.l,pData.s][i]);
                cont.innerHTML = "";
                document.getElementById('ref-box').classList.remove('hidden');
            };
            cont.appendChild(b);
        });
    };

    document.getElementById('btn-submit-turn').onclick = () => {
        pData.cur++;
        update(ref(db, 'players/' + pData.id), { m: pData.m, l: pData.l, s: pData.s, cur: pData.cur });
        document.getElementById('ref-box').classList.add('hidden');
        renderTurn();
    };

    // --- LOGIKA ADMIN (EXPOSE KE WINDOW AGAR TOMBOL BISA PANGGIL) ---
    document.getElementById('link-admin').onclick = (e) => {
        e.preventDefault();
        if(prompt("Sandi:") === "GuruSejarah") showScreen('scr-admin');
    };

    document.getElementById('btn-start-global').onclick = () => update(ref(db, '/'), { gameStatus: 'PLAYING' });
    document.getElementById('btn-reset-global').onclick = () => {
        if(confirm("Reset semua data?")) set(ref(db, '/'), { gameStatus: 'WAITING', players: {} });
    };

    // Tombol Kick & Edit diekspos ke global window
    window.kickPlayer = (id) => {
        if(confirm("Kick murid ini?")) update(ref(db, 'players/' + id), { status: 'KICKED' });
    };

    window.editPlayer = (id) => {
        const n = prompt("Ganti Nama Murid:", id);
        if(n) update(ref(db, 'players/' + id), { name: n });
    };

    // --- SINKRONISASI ---
    onValue(ref(db, 'missions'), snap => {
        if(snap.exists()) {
            missions = snap.val();
            document.getElementById('wait-msg').innerText = "Data misi siap. Menunggu Guru...";
        }
    });

    onValue(ref(db, 'gameStatus'), snap => {
        if(snap.val() === 'PLAYING' && !document.getElementById('scr-wait').classList.contains('hidden')) {
            showScreen('scr-game');
            renderTurn();
        }
    });

    onValue(ref(db, 'players'), snap => {
        const players = snap.val(); if(!players) return;
        
        // Cek status diri sendiri
        if(pData.id && players[pData.id]) {
            if(players[pData.id].status === 'KICKED') showScreen('scr-kicked');
            document.getElementById('lbl-myname').innerText = players[pData.id].name;
        }

        // Dashboard Guru
        const tbody = document.getElementById('monitor-body');
        if(tbody) {
            tbody.innerHTML = Object.keys(players).map(id => `
                <tr>
                    <td>${players[id].name}</td>
                    <td>Misi ${players[id].cur}</td>
                    <td>${players[id].m}/${players[id].l}/${players[id].s}</td>
                    <td>
                        <button class="btn-edit" onclick="window.editPlayer('${id}')">Edit</button>
                        <button class="btn-kick" onclick="window.kickPlayer('${id}')">Kick</button>
                    </td>
                </tr>
            `).join('');
        }
    });
</script>
</body>
</html>
