<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>RUANGSEJARAH - FINAL V30</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Oswald:wght@600&display=swap');
        
        :root { 
            --bg: #0f172a; --card: #f8fafc; --accent: #e11d48; 
            --ink: #1e293b; --soldier-off: #cbd5e1; --soldier-on: #22c55e; 
        }

        body { 
            margin: 0; background: var(--bg); color: var(--ink); 
            font-family: 'Courier Prime', monospace; overflow-x: hidden;
        }

        header { 
            background: #1e293b; color: white; padding: 20px; 
            text-align: center; border-bottom: 6px solid var(--accent);
        }
        header h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 2.2rem; letter-spacing: 2px; }

        main { max-width: 800px; margin: 30px auto; padding: 0 15px; }

        .card { 
            background: #fffefb; border-radius: 4px; padding: 35px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 2px solid var(--ink);
            border-right: 10px solid var(--accent); position: relative;
        }

        /* INPUT BESAR UNTUK MURID */
        input[type="text"], textarea {
            width: 100%; padding: 18px; font-size: 1.2rem; border: 3px solid var(--ink);
            border-radius: 0; font-family: inherit; box-sizing: border-box; background: #fff; margin-top: 10px;
        }

        button {
            width: 100%; padding: 18px; background: var(--ink); color: white;
            border: none; font-size: 1rem; font-weight: bold; cursor: pointer;
            text-transform: uppercase; transition: 0.2s; margin-top: 10px;
        }
        button:hover { background: var(--accent); }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .stat-box { background: #f1f5f9; padding: 10px; border: 2px solid var(--ink); text-align: center; }
        .stat-box b { font-size: 1.4rem; display: block; color: var(--accent); }

        .army-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin: 20px 0; }
        .dot { 
            width: 100%; aspect-ratio: 1; background: var(--soldier-off); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 10px;
            font-weight: bold; border: 1px solid #94a3b8; color: #64748b;
        }
        .dot.active { background: var(--soldier-on); color: white; border-color: #166534; }
        .dot.me { border: 3px solid var(--accent); animation: pulse 1s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .hidden { display: none !important; }

        /* ADMIN TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.75rem; background: white; }
        th { background: var(--ink); color: white; padding: 10px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-inner { background: white; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 25px; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <h1>RUANGSEJARAH</h1>
    <div style="font-size: 0.6rem; letter-spacing: 3px; opacity: 0.8;">OPERASI TERPADU v30</div>
</header>

<main>
    <div id="scr-login" class="card">
        <h2 style="text-align:center; margin-top:0;">IDENTIFIKASI UNIT</h2>
        <input type="text" id="in-name" placeholder="NAMA LENGKAP ANDA..." autocomplete="off">
        <button id="btn-reg">MASUK KE BARAK ⮕</button>
        <p style="text-align:center; margin-top:25px;">
            <a href="#" id="link-admin" style="color:var(--accent); font-size:0.8rem; text-decoration:none; font-weight:bold; border-bottom: 2px solid;">OTORITAS GURU</a>
        </p>
    </div>

    <div id="scr-wait" class="card hidden">
        <h2 style="text-align:center;">BARAK PERSIAPAN</h2>
        <div class="army-container" id="army-grid"></div>
        <div style="background:#f1f5f9; padding:15px; text-align:center; border:2px dashed var(--ink);">
            STATUS: <span id="lbl-status" style="color:var(--accent); font-weight:bold;">SIAGA</span><br>
            UNIT: <span id="display-name" style="font-weight:bold;">--</span>
        </div>
        <p style="text-align:center; font-size:0.8rem; color:#64748b;">Menunggu instruksi serangan dari Guru...</p>
    </div>

    <div id="scr-game" class="card hidden">
        <div class="stat-grid">
            <div class="stat-box"><small>MORAL</small><b id="v-m">50</b></div>
            <div class="stat-box"><small>SUPLAI</small><b id="v-l">50</b></div>
            <div class="stat-box"><small>DUKUNGAN</small><b id="v-s">50</b></div>
        </div>
        <div id="prog-text" style="font-size:0.75rem; color:var(--accent); margin-bottom:10px; font-weight:bold; letter-spacing:1px;"></div>
        <h3 id="ev-title" style="margin-top:0; color:var(--ink);"></h3>
        <p id="ev-desc" style="line-height:1.6; min-height:100px; color:#334155;"></p>
        <div id="opt-container"></div>
        
        <div id="ref-box" class="hidden">
            <p style="margin-top:20px; font-weight:bold;">ALASAN STRATEGIS:</p>
            <textarea id="ref-input" rows="3" placeholder="Tuliskan justifikasi Anda..."></textarea>
            <button id="btn-submit-turn" style="margin-top:10px;">LAPORKAN KE PUSAT</button>
        </div>
    </div>

    <div id="scr-admin" class="card hidden">
        <h2 style="margin-top:0;">PUSAT KOMANDO GURU</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <button id="btn-start-25" style="background:#0284c7;">MULAI 25 MISI</button>
            <button id="btn-start-60" style="background:#16a34a;">MULAI 60 MISI</button>
            <button id="btn-reset-global" style="background:#dc2626; grid-column: span 2;">RESET & KICK SEMUA UNIT</button>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>NAMA</th><th>MISI</th><th>STATUS</th><th>AKSI</th></tr>
                </thead>
                <tbody id="monitor-body"></tbody>
            </table>
        </div>
        <button onclick="location.reload()" style="background:#64748b; margin-top:20px;">KELUAR PANEL</button>
    </div>
</main>

<div id="scr-report" class="overlay hidden">
    <div class="modal-inner">
        <h2 id="rep-name" style="margin-top:0; border-bottom: 4px solid var(--ink);"></h2>
        <div id="rep-list"></div>
        <button onclick="document.getElementById('scr-report').classList.add('hidden')">TUTUP</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAclyNf8Dy69UD0X9IwuNo4QH3BfAzmfZY",
        authDomain: "sejarah-game.firebaseapp.com",
        projectId: "sejarah-game",
        databaseURL: "https://sejarah-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let pData = { id:"", name:"", m:50, l:50, s:50, cur:0, history:[] };
    let missions = [];
    let allPlayers = {};

    const showScreen = (id) => {
        document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    // --- LOGIKA MURID ---
    document.getElementById('btn-reg').onclick = () => {
        const n = document.getElementById('in-name').value.trim().toUpperCase();
        if(!n) return alert("NAMA TIDAK BOLEH KOSONG!");
        pData.id = n.replace(/\s+/g, '_') + '_' + Math.floor(1000 + Math.random() * 9000);
        pData.name = n;
        set(ref(db, 'players/' + pData.id), { ...pData, lastActive: Date.now() });
        document.getElementById('display-name').innerText = n;
        showScreen('scr-wait');
    };

    const renderTurn = () => {
        if(pData.cur >= missions.length && missions.length > 0) {
            document.getElementById('scr-game').innerHTML = "<h2 style='text-align:center'>MISI SELESAI</h2><p style='text-align:center'>Anda telah menyelesaikan simulasi. Mohon tunggu arahan guru selanjutnya.</p>";
            return;
        }
        const ev = missions[pData.cur];
        if(!ev) return;

        document.getElementById('prog-text').innerText = `PROGRES: ${pData.cur + 1} / ${missions.length}`;
        document.getElementById('ev-title').innerText = ev.title;
        document.getElementById('ev-desc').innerText = ev.desc;
        const cont = document.getElementById('opt-container');
        cont.innerHTML = "";
        
        ev.options.forEach(o => {
            const b = document.createElement('button');
            b.style = "background:white; color:var(--ink); border:2px solid var(--ink); text-align:left; margin-bottom:10px;";
            b.innerText = "◈ " + o.text;
            b.onclick = () => {
                pData.m += o.m; pData.l += o.l; pData.s += o.s;
                ['v-m','v-l','v-s'].forEach((id,i) => document.getElementById(id).innerText = [pData.m,pData.l,pData.s][i]);
                cont.innerHTML = ""; document.getElementById('ref-box').classList.remove('hidden');
            };
            cont.appendChild(b);
        });
    };

    document.getElementById('btn-submit-turn').onclick = () => {
        const res = document.getElementById('ref-input').value;
        pData.history.push({ step: pData.cur+1, year: missions[pData.cur].t, reason: res || "No reason provided" });
        pData.cur++;
        update(ref(db, 'players/' + pData.id), pData);
        document.getElementById('ref-input').value = "";
        document.getElementById('ref-box').classList.add('hidden');
        renderTurn();
    };

    // --- LOGIKA ADMIN ---
    document.getElementById('link-admin').onclick = (e) => {
        e.preventDefault();
        if(prompt("PASSWORD GURU:") === "sejarah") showScreen('scr-admin');
    };

    const triggerGame = (total) => {
        const m = [];
        for(let i=1; i<=total; i++) {
            m.push({
                t: 1945 + i, title: `OPERASI TAHUN ${1945+i}`,
                desc: `Sebuah krisis terjadi di wilayah sektor ${i}. Bagaimana perintah Anda sebagai Komandan?`,
                options: [
                    {text: "Ambil tindakan Pro-Rakyat (Moral+)", m:10, l:-5, s:10},
                    {text: "Ambil tindakan Pro-Militer (Suplai+)", m:-5, l:15, s:5}
                ]
            });
        }
        // Kirim misi dan ubah status game ke PLAYING
        set(ref(db, 'missions'), m);
        set(ref(db, 'gameStatus'), 'PLAYING_' + Date.now()); // Gunakan timestamp agar trigger selalu fresh
        alert(total + " Misi diaktifkan! Semua murid akan otomatis pindah layar.");
    };

    document.getElementById('btn-start-25').onclick = () => triggerGame(25);
    document.getElementById('btn-start-60').onclick = () => triggerGame(60);

    document.getElementById('btn-reset-global').onclick = () => {
        if(confirm("Hapus semua data murid?")) {
            set(ref(db, 'players'), null);
            set(ref(db, 'gameStatus'), 'WAITING');
            set(ref(db, 'missions'), null);
        }
    };

    window.viewReport = (id) => {
        const p = allPlayers[id];
        document.getElementById('rep-name').innerText = "LOG: " + p.name;
        document.getElementById('rep-list').innerHTML = p.history ? p.history.map(h => `
            <div style="border-bottom:1px solid #eee; padding:10px 0; font-size:0.8rem;">
                <b>MISI ${h.step} (${h.year}):</b><br><i>"${h.reason}"</i>
            </div>
        `).join('') : "Tidak ada data.";
        document.getElementById('scr-report').classList.remove('hidden');
    };

    window.kickPlayer = (id) => { if(confirm("Hapus unit?")) remove(ref(db, 'players/' + id)); };

    // --- REALTIME SYNC (INTI MASALAH TADI) ---
    onValue(ref(db, 'missions'), s => { missions = s.val() || []; });

    onValue(ref(db, 'gameStatus'), s => {
        const status = s.val() || "";
        // Jika status mengandung "PLAYING", murid yang sudah punya ID harus dipaksa masuk gameplay
        if(status.startsWith('PLAYING') && pData.id) {
            showScreen('scr-game');
            renderTurn();
        } else if(status === 'WAITING' && pData.id) {
            // Jika reset, balik ke login
            showScreen('scr-login');
        }
    });

    onValue(ref(db, 'players'), snap => {
        const players = snap.val() || {};
        allPlayers = players;

        // Kick logic
        if(pData.id && !players[pData.id]) { 
            pData.id = ""; 
            showScreen('scr-login'); 
            alert("Anda telah dikeluarkan atau sesi direset.");
            return; 
        }

        // Update Army Grid
        const grid = document.getElementById('army-grid');
        grid.innerHTML = "";
        const ids = Object.keys(players);
        for(let i=0; i<40; i++) {
            const d = document.createElement('div'); d.className = 'dot';
            if(ids[i]) {
                d.classList.add('active');
                if(ids[i] === pData.id) d.classList.add('me');
                d.innerText = players[ids[i]].name.substring(0,2);
            } else { d.innerText = i+1; }
            grid.appendChild(d);
        }

        // Update Admin Table
        const tbody = document.getElementById('monitor-body');
        if(tbody) {
            tbody.innerHTML = ids.map(id => `
                <tr>
                    <td>${players[id].name}</td>
                    <td>${players[id].cur}/${missions.length}</td>
                    <td>${players[id].cur === missions.length && missions.length > 0 ? 'SELESAI' : 'AKTIF'}</td>
                    <td>
                        <button onclick="window.viewReport('${id}')" style="background:#0ea5e9; padding:4px; font-size:9px; width:auto;">LOG</button>
                        <button onclick="window.kickPlayer('${id}')" style="background:red; padding:4px; font-size:9px; width:auto;">KICK</button>
                    </td>
                </tr>`).join('');
        }
    });
</script>
</body>
</html>
