<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>RuangSejarah RPG v3 - Peta Strategis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #1a2e1a;
      --paper: #f4ece0;
      --ink: #2c1e14;
      --accent: #b22222;
      --gold: #d4af37;
    }
    body {
      margin: 0;
      font-family: 'Georgia', serif;
      background: #2c3e50;
      color: var(--ink);
    }
    header {
      background: var(--primary);
      color: var(--gold);
      padding: 20px;
      text-align: center;
      border-bottom: 4px solid var(--gold);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    main { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
    
    .card {
      background: var(--paper);
      border: 2px solid #dcd1c1;
      border-radius: 8px;
      padding: 25px;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.1), 10px 10px 20px rgba(0,0,0,0.3);
      position: relative;
    }

    /* PETA VISUAL */
    .map-container {
      width: 100%;
      height: 250px;
      background: #a3c1ad;
      border: 5px solid var(--primary);
      margin: 15px 0;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
    }
    .island-shape {
      position: absolute;
      background: #e3d5b8;
      border: 2px solid #8b7355;
      border-radius: 50%;
    }
    .marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #444;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      transition: 0.3s;
    }
    .marker:hover { transform: scale(1.5); background: var(--accent); }
    .marker.active { background: var(--accent); box-shadow: 0 0 15px var(--accent); width: 16px; height: 16px; z-index: 10; }
    .marker-label { position: absolute; font-size: 10px; font-weight: bold; top: 18px; left: -10px; width: 60px; }

    /* STATS */
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0; }
    .stat-card {
      padding: 10px;
      text-align: center;
      border: 2px solid #8b7355;
      background: rgba(255,255,255,0.5);
    }
    .stat-card b { font-size: 20px; color: var(--accent); }
    .threshold-msg { font-size: 11px; font-style: italic; min-height: 15px; color: #555; }

    /* UI ELEMENTS */
    button {
      padding: 12px 24px;
      background: var(--primary);
      color: var(--gold);
      border: 1px solid var(--gold);
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
    }
    button:hover { background: #2d4d2d; }
    .option-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 15px;
      margin: 10px 0;
      background: #fff;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: 0.2s;
    }
    .option-btn:hover { background: #fdf5e6; border-color: var(--accent); }
    .hidden { display: none; }
    textarea { width: 100%; padding: 10px; border: 1px solid #8b7355; background: #fffcf5; box-sizing: border-box; }
    
    #admin-settings {
      background: #e8f4f8;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #aad;
    }
  </style>
</head>
<body>

<header>
  <h1>üèõÔ∏è RUANGSEJARAH RPG v3</h1>
  <p>Strategi Naratif Indonesia (1800‚Äì2000)</p>
</header>

<main>
  <div id="home" class="card">
    <h2 style="text-align:center">Pilih Peran</h2>
    <div style="display:flex; justify-content:center; gap:20px; padding:40px 0;">
      <button onclick="initGame()">üßë‚Äçüéì Masuk Sebagai Murid</button>
      <button style="background:#555" onclick="authAdmin()">üë©‚Äçüè´ Panel Guru</button>
    </div>
  </div>

  <div id="team-selection" class="card hidden">
    <h2>Pilih Wilayah Perjuangan</h2>
    <p>Klik titik di peta untuk memilih basis tim Anda:</p>
    <div class="map-container" id="selection-map"></div>
    <div id="team-detail" style="margin-top:15px; font-weight:bold; color:var(--accent)"></div>
    <div style="margin-top:20px">
      <button id="start-btn" class="hidden" onclick="beginSimulation()">Konfirmasi Wilayah ‚Æï</button>
    </div>
  </div>

  <div id="sim-screen" class="card hidden">
    <div class="stats-row">
      <div class="stat-card">üß† Moral<br><b id="st-moral">50</b><div class="threshold-msg" id="msg-moral"></div></div>
      <div class="stat-card">üì¶ Logistik<br><b id="st-logistik">50</b><div class="threshold-msg" id="msg-logistik"></div></div>
      <div class="stat-card">üåç Dukungan<br><b id="st-support">50</b><div class="threshold-msg" id="msg-support"></div></div>
    </div>

    <div class="map-container" id="sim-map"></div>

    <div id="event-box">
      <h3 id="ev-title"></h3>
      <p id="ev-desc"></p>
      <div id="options-container"></div>
    </div>

    <div id="reflection-box" class="hidden">
      <hr>
      <p><strong>Kenapa Anda mengambil keputusan ini?</strong> (Jelaskan strategi Anda)</p>
      <textarea id="ref-text" rows="3"></textarea>
      <button style="margin-top:10px" onclick="commitTurn()">Simpan & Lanjut Peristiwa ‚Æï</button>
    </div>
  </div>

  <div id="admin-panel" class="card hidden">
    <h2>üë©‚Äçüè´ Dashboard Guru</h2>
    <div id="admin-settings">
      <strong>‚öôÔ∏è Pengaturan Global:</strong><br>
      <label><input type="checkbox" id="mode-krisis"> <b>Mode Krisis:</b> (Semua pengurangan stat +5 lebih berat)</label><br>
      <label><input type="checkbox" id="mode-makmur"> <b>Mode Makmur:</b> (Mulai dengan Stat +20)</label>
    </div>
    <div id="rekap-data" style="max-height:300px; overflow-y:auto; background:white; padding:10px; border:1px solid #ccc;"></div>
    <br>
    <button onclick="location.reload()">Keluar Panel</button>
  </div>
</main>

<script>
// --- CONFIG DATA ---
const teamList = [
  { id:'batavia', name:'Batavia', x:25, y:70, desc:'Pusat birokrasi. Bonus: Support Dunia +10.' },
  { id:'yogya', name:'Yogyakarta', x:35, y:75, desc:'Kota Perjuangan. Bonus: Moral +10.' },
  { id:'surabaya', name:'Surabaya', x:45, y:75, desc:'Pusat Militansi. Bonus: Logistik +10.' },
  { id:'bandung', name:'Bandung', x:28, y:75, desc:'Pusat Intelektual. Bonus: Diplomasi Fleksibel.' },
  { id:'medan', name:'Medan', x:10, y:30, desc:'Gerbang Sumatera. Bonus: Ketahanan Wilayah.' },
  { id:'manado', name:'Manado', x:75, y:35, desc:'Benteng Timur. Bonus: Kekuatan Maritim.' }
];

const mainEvents = [
  { id:1, title:"Perang Diponegoro (1825)", desc:"Belanda membangun jalan di atas makam leluhur. Apa sikap tim Anda?", options:[
    { text:"Perang Gerilya", m:15, l:-10, s:5, out:"Rakyat bersatu, tapi sumber daya menipis." },
    { text:"Diplomasi Terbuka", m:-10, l:5, s:15, out:"Dunia luar simpati, tapi moral rakyat jatuh." }
  ]},
  { id:2, title:"Era Tanam Paksa", desc:"Pemerintah Kolonial mewajibkan 20% lahan untuk ekspor.", options:[
    { text:"Sabotase Produksi", m:10, l:-5, s:-10, out:"Rakyat tidak kelaparan, tapi patroli diperketat." },
    { text:"Ikuti Prosedur & Kumpulkan Dana", m:-5, l:15, s:5, out:"Logistik meningkat, namun penderitaan fisik berat." }
  ]},
  { id:3, title:"Sumpah Pemuda (1928)", desc:"Kongres berlangsung. Fokus utama tim Anda adalah...", options:[
    { text:"Persatuan Identitas Nasional", m:20, l:0, s:10, out:"Lahir kesadaran baru sebagai bangsa Indonesia." },
    { text:"Fokus Kemajuan Ekonomi Lokal", m:5, l:10, s:-5, out:"Ekonomi daerah kuat, tapi nasionalisme melambat." }
  ]}
];

const specialEvents = {
  'manado': { title:"Spesial Manado: Peristiwa Merah Putih", desc:"Tentara NICA mengancam kedaulatan di Sulut.", options:[
    { text:"Rebut Tangsi Putih", m:20, l:5, s:-5, out:"Manado membuktikan kesetiaan pada RI!" },
    { text:"Aksi Demonstrasi Massa", m:10, l:-5, s:15, out:"Dunia mengecam tindakan NICA." }
  ]},
  'batavia': { title:"Spesial Batavia: Aksi Mahasiswa", desc:"Terjadi demonstrasi besar di jantung ibukota.", options:[
    { text:"Mobilisasi Massa", m:15, l:-10, s:10, out:"Pusat pemerintahan terguncang." },
    { text:"Negosiasi di Belakang Layar", m:5, l:10, s:-5, out:"Stabilitas terjaga, perubahan lambat." }
  ]}
  // Tambahan kota lainnya bisa disisipkan di sini
};

// --- GAME LOGIC ---
let gameData = {
  team: null,
  moral: 50,
  logistik: 50,
  support: 50,
  currentIdx: 0,
  logs: [],
  isSpecialTriggered: false,
  specialAt: Math.floor(Math.random() * 2) + 1 // Muncul setelah event ke-1 atau ke-2
};

function drawMap(containerId, isActive = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '<div class="island-shape" style="width:200px; height:80px; top:60%; left:10%;"></div>' + 
                        '<div class="island-shape" style="width:100px; height:150px; top:10%; left:5%;"></div>' +
                        '<div class="island-shape" style="width:80px; height:80px; top:30%; left:70%;"></div>';
  
  teamList.forEach(t => {
    const marker = document.createElement('div');
    marker.className = `marker ${isActive && gameData.team === t.id ? 'active' : ''}`;
    marker.style.left = t.x + "%";
    marker.style.top = t.y + "%";
    marker.innerHTML = `<div class="marker-label">${t.name}</div>`;
    
    if(!isActive) {
      marker.onclick = () => {
        document.querySelectorAll('.marker').forEach(m => m.classList.remove('active'));
        marker.classList.add('active');
        gameData.team = t.id;
        document.getElementById('team-detail').innerText = `${t.name}: ${t.desc}`;
        document.getElementById('start-btn').classList.remove('hidden');
      };
    }
    container.appendChild(marker);
  });
}

function initGame() {
  document.getElementById('home').classList.add('hidden');
  document.getElementById('team-selection').classList.remove('hidden');
  drawMap('selection-map');
}

function beginSimulation() {
  // Cek Admin Settings
  if(document.getElementById('mode-makmur').checked) {
    gameData.moral = 70; gameData.logistik = 70; gameData.support = 70;
  }
  
  document.getElementById('team-selection').classList.add('hidden');
  document.getElementById('sim-screen').classList.remove('hidden');
  updateUI();
  nextEvent();
}

function nextEvent() {
  let ev;
  
  // Logic Random Special Event
  if (!gameData.isSpecialTriggered && gameData.currentIdx === gameData.specialAt && specialEvents[gameData.team]) {
    ev = specialEvents[gameData.team];
    gameData.isSpecialTriggered = true;
  } else if (gameData.currentIdx < mainEvents.length) {
    ev = mainEvents[gameData.currentIdx];
    gameData.currentIdx++;
  } else {
    finishGame();
    return;
  }

  renderEvent(ev);
}

function renderEvent(ev) {
  document.getElementById('ev-title').innerText = ev.title;
  document.getElementById('ev-desc').innerText = ev.desc;
  document.getElementById('options-container').innerHTML = '';
  document.getElementById('reflection-box').classList.add('hidden');
  document.getElementById('ref-text').value = '';

  ev.options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.innerHTML = `<b>${opt.text}</b>`;
    btn.onclick = () => selectOption(opt);
    document.getElementById('options-container').appendChild(btn);
  });
  drawMap('sim-map', true);
}

function selectOption(opt) {
  let krisis = document.getElementById('mode-krisis').checked ? 5 : 0;
  
  // Hitung Stat
  gameData.moral += (opt.m < 0 ? opt.m - krisis : opt.m);
  gameData.logistik += (opt.l < 0 ? opt.l - krisis : opt.l);
  gameData.support += (opt.s < 0 ? opt.s - krisis : opt.s);

  document.getElementById('ev-desc').innerHTML = `üí° <b>HASIL:</b> ${opt.out}`;
  document.getElementById('options-container').innerHTML = '';
  document.getElementById('reflection-box').classList.remove('hidden');
  
  gameData.lastTemp = { title: document.getElementById('ev-title').innerText, choice: opt.text };
  updateUI();
}

function commitTurn() {
  const ref = document.getElementById('ref-text').value;
  if(ref.length < 5) return alert("Berikan refleksi singkat!");

  gameData.logs.push({
    event: gameData.lastTemp.title,
    choice: gameData.lastTemp.choice,
    reflection: ref
  });

  // Simpan permanen ke localStorage agar Guru bisa lihat
  let history = JSON.parse(localStorage.getItem('sejarah_v3') || "[]");
  history.push({ team: gameData.team, time: new Date().toLocaleTimeString(), data: gameData.logs });
  localStorage.setItem('sejarah_v3', JSON.stringify(history));

  nextEvent();
}

function updateUI() {
  const stats = ['moral', 'logistik', 'support'];
  stats.forEach(s => {
    const val = gameData[s];
    document.getElementById(`st-${s}`).innerText = val;
    const msg = document.getElementById(`msg-${s}`);
    
    if(val <= 30) msg.innerText = "‚ö†Ô∏è KRISIS!";
    else if(val >= 100) msg.innerText = "üåü LEGENDARIS!";
    else msg.innerText = "";
  });
}

function finishGame() {
  document.getElementById('event-box').innerHTML = `<h3>üèÅ Simulasi Selesai!</h3><p>Anda telah mengukir sejarah dengan tim ${gameData.team.toUpperCase()}. Skor Akhir - Moral: ${gameData.moral}, Logistik: ${gameData.logistik}, Support: ${gameData.support}.</p>`;
  document.getElementById('reflection-box').innerHTML = '<button onclick="location.reload()">Main Lagi</button>';
}

// --- ADMIN LOGIC ---
function authAdmin() {
  const pass = prompt("Sandi Guru:");
  if(pass === "Sejarah123") {
    document.getElementById('home').classList.add('hidden');
    document.getElementById('admin-panel').classList.remove('hidden');
    renderRekap();
  } else {
    alert("Sandi Salah!");
  }
}

function renderRekap() {
  const history = JSON.parse(localStorage.getItem('sejarah_v3') || "[]");
  const cont = document.getElementById('rekap-data');
  if(history.length === 0) return cont.innerHTML = "Belum ada jawaban murid.";
  
  cont.innerHTML = history.reverse().map(h => `
    <div style="border-bottom:1px solid #ccc; padding:10px;">
      <b>Tim: ${h.team}</b> (${h.time})<br>
      ${h.data.map(d => `‚Ä¢ ${d.event}: <i>${d.choice}</i><br> &nbsp; R: ${d.reflection}`).join('<br>')}
    </div>
  `).join('');
}
</script>

</body>
</html>
