<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>RUANGSEJARAH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=Crimson+Text:wght@400;700&display=swap');
        :root { --ink: #003049; --paper: #fdf0d5; --gold: #c1121f; --danger: #d62828; --forest: #2d6a4f; --ussr: #cc0000; --usa: #002244; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Crimson Text', serif; background: #121212; color: var(--ink); line-height: 1.4; }
        header { background: var(--ink); color: white; padding: 0.8rem; text-align: center; font-family: 'Special Elite'; border-bottom: 4px solid var(--gold); }
        main { max-width: 800px; margin: 0 auto; padding: 10px; }
        .card { background: var(--paper); padding: 1.2rem; border: 3px solid var(--ink); box-shadow: 6px 6px 0 var(--gold); border-radius: 4px; margin-bottom: 1rem; }
        .hidden { display: none !important; }
        
        /* Stats Bar */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 1rem; }
        .stat-box { background: rgba(255,255,255,0.8); padding: 0.5rem; text-align: center; border: 2px solid var(--ink); border-radius: 4px; font-size: 0.9rem; }
        .stat-box b { display: block; font-size: 1.2rem; color: var(--gold); font-family: 'Special Elite'; }

        /* Army Grid */
        .army-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin: 15px 0; }
        .soldier { width: 100%; aspect-ratio: 1; background: #bdc3c7; border-radius: 50%; border: 1px solid var(--ink); display: flex; align-items: center; justify-content: center; font-size: 0.5rem; transition: 0.3s; }
        .soldier.active { background: var(--forest); color: white; }
        .soldier.me { border: 3px solid var(--gold); transform: scale(1.1); box-shadow: 0 0 10px var(--gold); }

        /* UI Elements */
        .opt-btn { background: white; color: var(--ink); text-align: left; border: 2px solid var(--ink); margin-bottom: 6px; padding: 10px; font-size: 0.9rem; cursor: pointer; display: block; width: 100%; border-radius: 4px; font-weight: 600; }
        button { padding: 12px; background: var(--ink); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; }
        textarea { width: 100%; padding: 10px; border: 2px solid var(--ink); border-radius: 4px; font-size: 1rem; }
        
        .intervention-overlay { background: rgba(0,0,0,0.85); position: fixed; top:0; left:0; width:100%; height:100%; z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

<header><h1>RUANGSEJARAH</h1></header>

<main>
    <div id="scr-login" class="card">
        <h2 style="text-align:center;">Registrasi Divisi</h2>
        <input type="text" id="in-name" placeholder="Nama Lengkap..." autocomplete="off">
        <button id="btn-reg">MASUK OPERASI ⮕</button>
        <p style="text-align:center;"><a href="#" id="link-admin" style="color:var(--gold); font-size:0.8rem; text-decoration:none;">Otoritas Guru</a></p>
    </div>

    <div id="scr-wait" class="card hidden">
        <h3 style="text-align:center;">MENUJU MEDAN TEMPUR</h3>
        <div class="army-grid" id="army-container"></div>
        <p style="text-align:center;">Unit <b><span id="lbl-myname"></span></b> Menunggu Komando...</p>
    </div>

    <div id="scr-intervene" class="intervention-overlay hidden">
        <div class="card" style="max-width: 400px; text-align: center;">
            <h2 id="int-title" style="color:var(--gold)"></h2>
            <p id="int-body"></p>
            <button id="btn-int-ok">TERIMA INSTRUKSI</button>
        </div>
    </div>

    <div id="scr-game" class="card hidden">
        <div class="stat-grid">
            <div class="stat-box">MORAL<br><b id="v-m">50</b></div>
            <div class="stat-box">SUPLAI<br><b id="v-l">50</b></div>
            <div class="stat-box">DUKUNGAN<br><b id="v-s">50</b></div>
        </div>
        <h3 id="ev-title" style="color:var(--gold); font-family:'Special Elite'; margin-top:0;"></h3>
        <p id="ev-desc" style="margin-bottom:15px;"></p>
        <div id="opt-container"></div>
        
        <div id="ref-box" class="hidden">
            <hr>
            <p><b>Justifikasi Strategis:</b></p>
            <textarea id="ref-input" rows="2" placeholder="Tulis alasan singkat..."></textarea>
            <button id="btn-submit-turn" style="margin-top:10px;">LAPOR ⮕</button>
        </div>
    </div>

    <div id="scr-admin" class="card hidden">
        <h2>Pusat Komando</h2>
        <button id="btn-start-global" style="background:var(--forest);">MULAI GAME</button>
        <button id="btn-reset-global" style="background:var(--danger); margin-top:5px;">RESET TOTAL</button>
        <button id="btn-inject-25" style="background:#555; margin-top:5px;">AKTIFKAN 25 MISI UTAMA</button>

        <div style="margin-top:15px; overflow-x:auto;">
            <table style="width:100%; font-size:0.75rem; border-collapse:collapse;">
                <thead style="background:#ddd;"><tr><th>Nama</th><th>Misi</th><th>M/L/S</th><th>Ideologi</th><th>Aksi</th></tr></thead>
                <tbody id="monitor-body"></tbody>
            </table>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAclyNf8Dy69UD0X9IwuNo4QH3BfAzmfZY",
        authDomain: "sejarah-game.firebaseapp.com",
        projectId: "sejarah-game",
        databaseURL: "https://sejarah-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let pData = { id:"", name:"", m:50, l:50, s:50, cur:0, r_count:0, m_count:0, ideology: "Netral" };
    let missions = [];

    const showScreen = (id) => {
        document.querySelectorAll('main > div').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    // --- LOGIKA MURID ---
    document.getElementById('btn-reg').onclick = () => {
        const n = document.getElementById('in-name').value.trim();
        if(!n) return;
        pData.id = n.replace(/\s+/g, '_') + '_' + Math.floor(Math.random()*1000);
        pData.name = n;
        set(ref(db, 'players/' + pData.id), { ...pData, status: 'ALIVE' });
        document.getElementById('lbl-myname').innerText = pData.name;
        showScreen('scr-wait');
    };

    const checkKarma = () => {
        // Intervensi Random & Ideologi (Mulai Misi 8+)
        if (pData.cur > 7 && Math.random() > 0.7) {
            let title = "", body = "";
            
            if (pData.r_count >= 4) {
                title = "DUKUNGAN RAKYAT";
                body = "Rakyat mengingat jasa Anda. Mereka mengirimkan perbekalan rahasia.";
                pData.l += 15;
            } else if (pData.m_count >= 4) {
                title = "SUPREMASI MILITER";
                body = "Jenderal-jenderal loyal kepada Anda. Moral pasukan meningkat pesat.";
                pData.m += 15;
            } else if (pData.l < 15) {
                title = "BANTUAN AS";
                body = "Paman Sam mengirim Suplai, tapi minta pangkalan militer dibangun.";
                pData.l += 20; pData.s -= 10;
            }

            if (title) {
                document.getElementById('int-title').innerText = title;
                document.getElementById('int-body').innerText = body;
                document.getElementById('scr-intervene').classList.remove('hidden');
                return true;
            }
        }
        return false;
    };

    const renderTurn = () => {
        if(pData.m <= 0 || pData.l <= 0 || pData.s <= 0) {
            alert("NEGARA RUNTUH! Statistik Anda menyentuh 0.");
            location.reload(); return;
        }
        if(pData.cur >= missions.length) {
            alert("MISI SELESAI! Anda berhasil memandu bangsa.");
            location.reload(); return;
        }

        const ev = missions[pData.cur];
        document.getElementById('ev-title').innerText = `${ev.t}: ${ev.title}`;
        document.getElementById('ev-desc').innerText = ev.desc;
        const cont = document.getElementById('opt-container');
        cont.innerHTML = "";

        ev.options.forEach(o => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = o.text;
            b.onclick = () => {
                pData.m += o.m; pData.l += o.l; pData.s += o.s;
                ['v-m','v-l','v-s'].forEach((id,i) => document.getElementById(id).innerText = [pData.m,pData.l,pData.s][i]);
                cont.innerHTML = ""; document.getElementById('ref-box').classList.remove('hidden');
            };
            cont.appendChild(b);
        });
    };

    document.getElementById('btn-submit-turn').onclick = () => {
        const reason = document.getElementById('ref-input').value.toLowerCase();
        // NLP Counter
        if(reason.includes("rakyat") || reason.includes("desa") || reason.includes("warga")) pData.r_count++;
        if(reason.includes("militer") || reason.includes("senjata") || reason.includes("serang")) pData.m_count++;
        
        // Update Ideology Status
        if(pData.r_count >= 4) pData.ideology = "Pro-Rakyat";
        if(pData.m_count >= 4) pData.ideology = "Pro-Militer";

        pData.cur++;
        update(ref(db, 'players/' + pData.id), { 
            m: pData.m, l: pData.l, s: pData.s, cur: pData.cur, 
            ideology: pData.ideology, r_count: pData.r_count, m_count: pData.m_count 
        });

        document.getElementById('ref-input').value = "";
        document.getElementById('ref-box').classList.add('hidden');
        if (!checkKarma()) renderTurn();
    };

    document.getElementById('btn-int-ok').onclick = () => {
        document.getElementById('scr-intervene').classList.add('hidden');
        renderTurn();
    };

    // --- ADMIN ---
    document.getElementById('link-admin').onclick = () => { if(prompt("Sandi:") === "GuruSejarah") showScreen('scr-admin'); };
    document.getElementById('btn-start-global').onclick = () => update(ref(db, '/'), { gameStatus: 'PLAYING' });
    document.getElementById('btn-reset-global').onclick = () => { if(confirm("Hapus semua?")) set(ref(db, '/'), { gameStatus: 'WAITING', players: {}, missions: [] }); };
    
    document.getElementById('btn-inject-25').onclick = () => {
        const t = [];
        for(let i=1; i<=25; i++) {
            t.push({
                t: 1945 + i, title: `Peristiwa Sejarah ${i}`,
                desc: `Deskripsi singkat kejadian strategis ke-${i} untuk pengambilan keputusan cepat.`,
                options: [
                    {text: "Opsi Rakyat", m:10, l:-5, s:10}, {text: "Opsi Militer", m:5, l:10, s:-5},
                    {text: "Opsi Diplomasi", m:5, l:5, s:15}, {text: "Opsi Sabotase", m:20, l:-20, s:0}
                ]
            });
        }
        set(ref(db, 'missions'), t); alert("25 Misi Utama Siap!");
    };

    // --- SYNC ---
    onValue(ref(db, 'missions'), snap => { missions = snap.val() || []; });
    onValue(ref(db, 'gameStatus'), snap => {
        if(snap.val() === 'PLAYING' && !document.getElementById('scr-wait').classList.contains('hidden')) {
            showScreen('scr-game'); renderTurn();
        }
    });
    onValue(ref(db, 'players'), snap => {
        const players = snap.val() || {};
        const container = document.getElementById('army-container');
        container.innerHTML = "";
        const ids = Object.keys(players);
        for(let i=0; i<40; i++) {
            const div = document.createElement('div'); div.className = 'soldier';
            if(ids[i]) { div.classList.add('active'); div.innerText = players[ids[i]].name.substring(0,2); if(ids[i] === pData.id) div.classList.add('me'); }
            else { div.innerText = i+1; }
            container.appendChild(div);
        }
        const tbody = document.getElementById('monitor-body');
        if(tbody) {
            tbody.innerHTML = Object.keys(players).map(id => `
                <tr><td>${players[id].name}</td><td>${players[id].cur}</td><td>${players[id].m}/${players[id].l}/${players[id].s}</td>
                <td style="color:${players[id].ideology==='Pro-Rakyat'?'green':'red'}">${players[id].ideology}</td>
                <td><button onclick="window.kickPlayer('${id}')" style="background:red; font-size:9px; padding:2px">Kick</button></td></tr>
            `).join('');
        }
    });
    window.kickPlayer = (id) => update(ref(db, 'players/'+id), {status:'KICKED'});
</script>
</body>
</html>
